<!DOCTYPE html>
<html>
    <head>
        <title>A1 PokeAPI</title>
        <link rel="stylesheet" href="index.css">
    </head>
    <body>
        <div id="content">
            <header>
                <h1><a href="../index.html">PokeAPI Client</a></h1>
                <form action="pokemon.html">
                    <select name="abilities" id="ability" onchange="displayByAbility();">
                        <option value="null">Select Ability</option>
                    </select>
                    <select name="types" id="type" onchange="displayByType();">
                        <option value="null">Select Type</option>
                    </select>
                    
                    <input type="text" id="search" name="search" placeholder="Search by name..." value="" />
                    <button type="submit">Search</button>
                </form>
            </header>
            <div id="pokemons">
            <template id="pokemonContainerTemplate">
                <div class="pokemonContainer" onclick="search(this.querySelector('.pokemonName').innerHTML)">
                    <h2 class="pokemonName"></h2>
                    <img class="pokemonArt"/>
                    <div class="pokemonStats">
                        <div class="types">

                        </div>
                    </div>
                </div>
            </template>
            </div>
            <footer>
                <p>Lachlan Butler - 2022</p>
            </footer>
        </div>
        <script src="./pokeApiStuff.js"></script>
        <script>
            function search() {
                if (document.querySelector("#search").value == "") { return; }
                window.location.assign("./pokemon.html?search=" + document.querySelector("#search").value);
            }

            function search(pokerman) {
                window.location.assign("./pokemon.html?search=" + pokerman);
            }

            function fillRandomPokemons() {
                response = getRandomPokemon();

                let parent = document.querySelector("#pokemons");
                for (let i = 0; i < 9; i++) {
                    response = getRandomPokemon();
                    addPokemon(parent, response);
                }
            }

            function purgePokemon(parent) {
                const nodes = document.querySelectorAll(".pokemonContainer");
                for (let i = 0; i < nodes.length; i++) {
                    parent.removeChild(nodes[i]);
                }
            }

            function addPokemon(parent, pokemon) {
                let template = document.querySelector("#pokemonContainerTemplate").content.cloneNode(true);
                
                template.querySelector(".pokemonArt").setAttribute("src", getPokemonArtUrl(pokemon));
                template.querySelector(".pokemonName").innerHTML = getPokemonName(pokemon);

                let typesDiv = template.querySelector(".types");

                for (let i = 0; i < pokemon["types"].length; i++) {
                    let newNode = document.createElement("p");
                    newNode.setAttribute("class", "type");
                    newNode.innerHTML = pokemon["types"][i]["type"]["name"];
                    newNode.setAttribute("style", "background-color:" + getTypeColour(pokemon["types"][i]["type"]["name"]) + ";");
                    typesDiv.appendChild(newNode);
                }
                
                parent.appendChild(template)
            }

            function getListIntersect(a1, a2) {
                return a1.filter(p => a2.map((a) => a.species.name).includes(p.species.name));
            }

            async function displayByType() {
                const parent = document.querySelector("#pokemons");

                if (document.querySelector("#type").value == "null") { 
                    allPokemonType = [];
                    if (document.querySelector("#ability").value == "null") {
                        window.location.reload();
                        return;
                    } else {
                        displayByAbility();
                        return;
                    }
                }

                let response = getPokemonsByType(document.querySelector("#type").value);
                purgePokemon(parent);

                allPokemonType = [];
                for (let i = 0; i < response.length; i++) {
                    allPokemonType.push(getRequest(response[i]["pokemon"]["url"]));
                }

                let pIntersect = []
                pIntersect = allPokemonAbility.length == 0 ? allPokemonType : getListIntersect(allPokemonType, allPokemonAbility);

                for (let i = 0; i < pIntersect.length; i++) {
                    addPokemon(parent, pIntersect[i]);
                }
            }

            async function displayByAbility() {
                const parent = document.querySelector("#pokemons");

                if (document.querySelector("#ability").value == "null") { 
                    allPokemonAbility = [];
                    if (document.querySelector("#type").value == "null") {
                        window.location.reload();
                        return;
                    } else {
                        displayByType();
                        return;
                    }
                }

                let response = getPokemonsByAbility(document.querySelector("#ability").value);
                purgePokemon(parent);

                allPokemonAbility = [];
                for (let i = 0; i < response.length; i++) {
                    allPokemonAbility.push(getRequest(response[i]["pokemon"]["url"]));
                }

                let pIntersect = []
                pIntersect = allPokemonType.length == 0 ? allPokemonAbility : getListIntersect(allPokemonType, allPokemonAbility);

                for (let i = 0; i < pIntersect.length; i++) {
                    addPokemon(parent, pIntersect[i]);
                }
            }

            function populateSelector(parent, url) {
                const response = getRequest(url);

                let allEntries = [];
                for (let i = 0; i < response.count; i++) {
                    allEntries.push(response["results"][i]);
                }
                allEntries.sort(compareThings);

                for (let i = 0; i < allEntries.length; i++) {
                    let newNode = document.createElement("option");
                    newNode.value = allEntries[i].name;
                    newNode.innerHTML = toTitleCase(allEntries[i].name);
                    parent.appendChild(newNode);
                }
            }

            function toTitleCase(str) {
                // Didn't want to figure this out myself, https://stackoverflow.com/a/40111894
                return str.toLowerCase().replace(/\b(\w)/g, s => s.toUpperCase());
            }

            function compareThings(t1, t2) {
                return t1.name.localeCompare(t2.name);
            }

            populateSelector(document.querySelector("#ability"), "https://pokeapi.co/api/v2/ability/?limit=999");
            populateSelector(document.querySelector("#type"), "https://pokeapi.co/api/v2/type/?limit=999");

            let allPokemonType = [];
            let allPokemonAbility = [];

            window.onload = function() {
                if (document.querySelector("#type").value == "null" && document.querySelector("#ability").value == "null") {
                    fillRandomPokemons();
                } else {
                    displayByType();
                    displayByAbility();
                }
            }
        </script>
    </body>
</html>
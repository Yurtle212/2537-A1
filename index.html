<!DOCTYPE html>
<html>
    <head>
        <title>A1 PokeAPI</title>
        <link rel="stylesheet" href="index.css">
    </head>
    <body>
        <div id="content">
            <header>
                <h1><a href="../index.html">PokeAPI Client</a></h1>
                <form action="pokemon.html">
                    <select name="abilities" id="ability" onchange="displayFiltered();">
                        <option value="null">Select Ability</option>
                    </select>
                    <select name="moves" id="move" onchange="displayFiltered();">
                        <option value="null">Select Move</option>
                    </select>
                    <select name="types" id="type" onchange="displayFiltered();">
                        <option value="null">Select Type</option>
                    </select>
                    
                    <input type="text" id="search" name="search" placeholder="Search by name..." value="" />
                    <button type="submit">Search</button>
                </form>
            </header>
            <div id="pokemons">
            <template id="pokemonContainerTemplate">
                <div class="pokemonContainer" onclick="search(this.querySelector('.pokemonName').innerHTML)">
                    <h2 class="pokemonName"></h2>
                    <img class="pokemonArt"/>
                    <div class="pokemonStats">
                        <div class="types">

                        </div>
                    </div>
                </div>
            </template>
            </div>
            <footer>
                <p>Lachlan Butler - 2022</p>
            </footer>
        </div>
        <script src="./pokeApiStuff.js"></script>
        <script src="./misc.js"></script>
        <script>
            function search() {
                if (document.querySelector("#search").value == "") { return; }
                window.location.assign("./pokemon.html?search=" + document.querySelector("#search").value);
            }

            function search(pokerman) {
                window.location.assign("./pokemon.html?search=" + pokerman);
            }

            function fillRandomPokemons() {
                response = getRandomPokemon();

                let parent = document.querySelector("#pokemons");
                for (let i = 0; i < 9; i++) {
                    response = getRandomPokemon();
                    addPokemon(parent, response);
                }
            }

            function purgePokemon(parent) {
                const nodes = document.querySelectorAll(".pokemonContainer");
                for (let i = 0; i < nodes.length; i++) {
                    parent.removeChild(nodes[i]);
                }
            }

            function addPokemon(parent, pokemon) {
                return new Promise(resolve => {
                    let template = document.querySelector("#pokemonContainerTemplate").content.cloneNode(true);
                
                    template.querySelector(".pokemonArt").setAttribute("src", getPokemonArtUrl(pokemon));
                    template.querySelector(".pokemonName").innerHTML = getPokemonName(pokemon);

                    let typesDiv = template.querySelector(".types");

                    fillTypes(typesDiv, pokemon);
                    parent.appendChild(template);
                    resolve(true);
                });
            }

            function fillTypes(parent, pokemon) {
                for (let i = 0; i < pokemon["types"].length; i++) {
                    let newNode = document.createElement("p");
                    newNode.setAttribute("class", "type");
                    newNode.innerHTML = pokemon["types"][i]["type"]["name"];
                    newNode.setAttribute("style", "background-color:" + getTypeColour(pokemon["types"][i]["type"]["name"]) + ";");
                    parent.appendChild(newNode);
                }
            }

            function getListIntersect(...lists) {
                let i = 0;
                let finalList = [];

                while (finalList.length == 0 && i < lists.length) {
                    finalList = lists[i];
                    i++;
                }

                for (i; i < lists.length; i++) {
                    if (lists[i].length == 0) { continue; }
                    finalList = finalList.filter(p => lists[i].map((a) => a.forms[0].name).includes(p.forms[0].name));
                }
                
                return finalList;
            }

            function getFlag(...queries) {
                let flag = 0;
                for (let i = 0; i < queries.length; i++) {
                    if (document.querySelector(queries[i]).value != "null") { 
                        flag |= 1 << i;
                    }
                }

                return flag;
            }

            async function displayFiltered() {
                const parent = document.querySelector("#pokemons");
                purgePokemon(parent);

                let flag = getFlag("#type", "#ability", "#move");
                console.log(flag & 0b010);

                if ((flag & 0b111) == 0) {
                    window.location.reload();
                    return;
                }

                if ((flag & 0b001) != 0) { // Type
                    //console.log("Type");
                    await getTypePokemon();
                }
                if ((flag & 0b010) != 0) { // Ability
                    //console.log("Ability");
                    await getAbilityPokemon();
                }
                if ((flag & 0b100) != 0) { // Move
                    //console.log("Move");
                    await getMovePokemon();
                }


                let pIntersect = []
                pIntersect = getListIntersect(allPokemonType, allPokemonAbility, allPokemonMove);

                for (let i = 0; i < pIntersect.length; i++) {
                    await addPokemon(parent, pIntersect[i]);
                }
                console.log("Burh");
            }

            function getMovePokemon() {
                return new Promise(resolve => {
                    async function doStuff() {
                        console.log("Move")
                        let response = getPokemonsByMove(document.querySelector("#move").value);

                        allPokemonMove = [];
                        for (let i = 0; i < response.length; i++) {
                            allPokemonMove.push(await getRequestAsync(response[i]["url"]));
                        }
                        resolve(true);
                    }
                    doStuff();
                });
            }

            function getTypePokemon() {
                return new Promise(resolve => {
                    async function doStuff() {
                        console.log("Type")
                        let response = getPokemonsByType(document.querySelector("#type").value);

                        allPokemonType = [];
                        for (let i = 0; i < response.length; i++) {
                            allPokemonType.push(await getRequestAsync(response[i]["pokemon"]["url"]));
                            //allPokemonType.push(getRequest(response[i]["pokemon"]["url"]));
                        }
                        resolve(true);
                    }
                    doStuff();
                });
            }

            function getAbilityPokemon() {
                return new Promise(resolve => {
                    async function doStuff() {
                        console.log("Ability")
                        let response = getPokemonsByAbility(document.querySelector("#ability").value);

                        allPokemonAbility = [];
                        for (let i = 0; i < response.length; i++) {
                            allPokemonAbility.push(await getRequestAsync(response[i]["pokemon"]["url"]));
                        }
                        resolve(true);
                    }
                    doStuff();
                });
            }
            
            populateSelector(document.querySelector("#ability"), "https://pokeapi.co/api/v2/ability/?limit=9999");
            populateSelector(document.querySelector("#type"), "https://pokeapi.co/api/v2/type/?limit=9999");
            populateSelector(document.querySelector("#move"), "https://pokeapi.co/api/v2/move/?limit=9999");

            let allPokemonType = [];
            let allPokemonAbility = [];
            let allPokemonMove = [];

            window.onload = function() {
                if (document.querySelector("#type").value == "null" && document.querySelector("#ability").value == "null") {
                    fillRandomPokemons();
                } else {
                    displayByType();
                    displayByAbility();
                }
            }
        </script>
    </body>
</html>